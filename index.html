<style>
.bar-container {
	margin: 2px 0;
}
</style>

<p>Paste numbers, get bar graph PNGs.
<p><textarea id="numbers" rows="8" data-bind="value: numbersString, valueUpdate: 'afterkeydown'"></textarea>
<hr />
<div id="bars2" data-bind="foreach: barImageDatas">
	<div class="bar-container"><img data-bind="attr: { src: src }" /></div>
</div>

<script src="jquery.js"></script>
<script src="pnglib.js"></script>
<script src="knockout.js"></script>
<script>
var $numbers = $('#numbers');
var $bars = $('#bars');

var numbersString = ko.observable([10, 20, 30, 50, 90, 40].join('\n'));
var numbers = ko.computed(function () {
	return numbersString().split('\n').map(function (n) { return parseFloat(n) });
});
var maxNumber = ko.computed(function () {
	return numbers().slice().filter(isFinite).sort(function (a, b) { return b-a })[0];
});
var imageDatas = ko.computed(function () {
	var minvalue = 0, maxvalue = maxNumber();
	var minbarwidth = 0, maxbarwidth = 200;
	return numbers().map(function (n) {
		var barwidth = minbarwidth + (n - minvalue) / (maxvalue - minvalue) * (maxbarwidth - minbarwidth);
		return { src: barImageData(maxbarwidth, 10, barwidth) };
	});
});

ko.applyBindings({
	numbersString: numbersString,
	barImageDatas: imageDatas,
});

function barImageData(width, height, barwidth) {
	width = Math.max(Math.round(width), 1);
	height = Math.max(Math.round(height), 1);
	var p = new PNGlib(width, height, 256); // constructor takes height, weight and color-depth
	p.color(0, 0, 0, 0); // set the background
	
	for (var x = 0; x < barwidth; x++) {
		for (var y = 0; y < height; y++) {
			p.buffer[p.index(x, y)] = p.color(0xcc, 0xcc, 0xcc);
		}
	}
	
	return 'data:image/png;base64,'+p.getBase64();
}

</script>
